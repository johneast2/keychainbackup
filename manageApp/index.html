<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
<script>window.$ = window.jQuery = require('jquery');</script>
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
<script src="assets/js/jquery-ui.min.js"></script>
<script src="render.js"></script>
<script>
         $(function() {
            $( "#progressbar" ).progressbar({
               value: 0
            });
         });

	$( function() {
	    $( "#advancedAccordion" ).accordion();
	  } );
      </script>
    <title>Keychain Backup Device Manager</title>
</head>

<body>
    <div id="setupDeviceDiv">
    <h1>Keychain Backup Device Manager</h1>
        <div id="setupformDiv">
    	<div id="ipAddressErrorMessage">
    	</div>
        Omega2 ip address:
        <input type="text" maxlength="3" size="3" id="octetA"></input>.<input type="text" maxlength="3"size="3" id="octetB"></input>.<input type="text" maxlength="3"size="3" id="octetC"></input>.<input type="text" maxlength="3"size="3" id="octetD"></input><br>
        Omega2 ssh Password (Leave blank to not change):<input type="text" id="sshPassword"></input><br>
	<div id="encryptedErrorMessage">
    	</div>
	Encrypted Container Password:<input type="text" id="encPassword"></input><br>
	<button type="button" class="btn btn-primary" id="setupDeviceButton">
	    Setup Device
	</button>
	<br>
	<br>
	<br>
        <div id="advancedAccordion">
		<h3>Advanced Options</h3>
		  <div>
		    <p>
			Omega2 current password: <input id="currentPassword" type="text" placeholder="onioneer"></input>
		    </p>
		    <p>
			Hide Omega2 SSID:<input type="checkbox" id="hideSsid" checked>
		    </p>
		  </div>

	</div>
        </div>
     </div>
     <div id="confirmDelete">
        <H1>!! WARNING !!</H1><br>
        This setup process will delete all files on the usb drive.<br><br>
        <button type="button" class="btn btn-warning" id="confirmSetupDeviceButton">
	    I understand that all files will be erased!<br><br>Click here to continue with setup
	</button>
     </div>
     <div id="setupStatusDiv">
         <h1>Connecting to device...</h1>
         <br>
     </div>
         <div id = "progressbar"></div> 
</body>

<script>

document.addEventListener("DOMContentLoaded", function(){
	$('#setupStatusDiv').hide();
	$('#confirmDelete').hide();
	$('#progressbar').hide();


	$("#advancedAccordion").accordion({
	  active: false,
	  collapsible: true
	});
});

const { ipcRenderer } = require('electron');

$("#setupDeviceButton").on('click', () => {

	$('#setupformDiv').hide();
	$('#confirmDelete').show();


});

$("#confirmSetupDeviceButton").on('click', () => {
    var setupArgs = {};
    setupArgs["octetA"] = $("#octetA").val();
    setupArgs["octetB"] = $("#octetB").val();
    setupArgs["octetC"] = $("#octetC").val();
    setupArgs["octetD"] = $("#octetD").val();
    setupArgs["sshPassword"] = $("#sshPassword").val();
    setupArgs["encPassword"] = $("#encPassword").val();
    setupArgs["currentPassword"] = $("#currentPassword").val();
    setupArgs["hideSsid"] = $('#hideSsid').prop('checked');

    $('#confirmDelete').hide();

    var result = ipcRenderer.sendSync('setupDevice', setupArgs);

    console.log("result = " + result);
	if (result["validIpAddress"] === false)
	{
		$('#ipAddressErrorMessage').css('background-color', 'OrangeRed');
		$('#ipAddressErrorMessage').html("Invalid IP Address for device!");
		$('#ipAddressErrorMessage').show();
		$('#setupformDiv').show();
	}
	else 
	{
		$('#ipAddressErrorMessage').hide();
	}
	if (result["validEncPassword"] === false)
	{
		$('#encryptedErrorMessage').css('background-color', 'OrangeRed');
		$('#encryptedErrorMessage').html("Encrypted Container Password cannot be empty!");
		$('#encryptedErrorMessage').show();
                $('#setupformDiv').show();
	}
	else
	{
		$('#encryptedErrorMessage').hide();
	}
});

ipcRenderer.on('async-status', (event, arg) => {
    $('#setupformDiv').hide();

    $('#setupStatusDiv').html("<h1>" + arg + "</H1>");

    $('#setupStatusDiv').show();
	$('#progressbar').show();
})

ipcRenderer.on('async-progress', (event, arg) => {
	$('#progressbar').progressbar("value", arg); 
})
</script>
</html>
